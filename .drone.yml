pipeline:
  dep:
    commands:
    - cd api
    - dep ensure -v
    - '[[ -z "$(git diff)" ]]'
    image: metalmatze/dep:0.5.0
    pull: true
  gofmt:
    commands:
    - cd api
    - make gofmt
    image: golang:1.11.0
    pull: true
  verify-codegen:
    commands:
    - cd api
    - ./hack/verify-codegen.sh
    image: golang:1.11.0
    pull: true
  license-validation:
    commands:
    - cd api
    - wwhrd check -f ../allowed_licensed.yaml
    group: lint
    image: metalmatze/wwhrd:1.9
    pull: true
  lint:
    commands:
    - cd api
    - make lint
    group: lint
    image: quay.io/kubermatic/gometalinter:latest
    pull: true
  verify-addons-up-to-date:
    commands:
    - ./api/hack/verify-addon-version.sh
    group: lint
    image: docker:dind
    pull: true
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
  verify-swagger-spec:
    commands:
    - cd api
    - ./hack/verify-swagger.sh
    group: lint
    image: golang:1.11.0
    pull: true
  build:
    commands:
    - cd api
    - make build
    group: build
    image: golang:1.11.0
    pull: true
  test:
    commands:
    - cd api
    - make test
    group: build
    image: golang:1.11.0
    pull: true
  kubermatic-docker-master:
    context: api
    dockerfile: api/Dockerfile
    group: push-master
    image: plugins/docker
    pull: true
    repo: kubermatic/api
    secrets:
    - docker_username
    - docker_password
    tags:
    - master
    - ${DRONE_COMMIT}
    when:
      branch: master
  # this will build docker images for every release/v2.8 commit
  # to be immediately deployed on run.kubermatic.io
  kubermatic-docker-release-v28:
    context: api
    dockerfile: api/Dockerfile
    group: push-master
    image: plugins/docker
    pull: true
    repo: kubermatic/api
    secrets:
    - docker_username
    - docker_password
    tags:
    - ${DRONE_COMMIT}
    when:
      branch: release/v2.8
  kubermatic-docker-release:
    context: api
    dockerfile: api/Dockerfile
    group: push-master
    image: plugins/docker
    pull: true
    repo: kubermatic/api
    secrets:
    - docker_username
    - docker_password
    tags:
    - ${DRONE_TAG}
    - latest
    when:
      event:
      - tag
  sync-charts:
    commands:
    - apk add --no-cache -U git bash openssh
    - git fetch
    - export LATEST_VERSION=$(git describe --tags --abbrev=0)
    - sed -i "s/__KUBERMATIC_TAG__/$LATEST_VERSION/g" config/kubermatic/values.yaml
    - git config --global user.email "dev@loodse.com"
    - git config --global user.name "drone"
    - cd api && ./hack/sync-charts.sh ${DRONE_BRANCH} ../config
    image: alpine:3.7
    pull: true
    when:
      branch:
        exclude:
        - release/v1.*
        - release/*cherry*
        include:
        - release/*
  deploy-dev:
    charts:
    - name: kubermatic
      namespace: kubermatic
      path: config/kubermatic/
    - name: nodeport-proxy
      namespace: nodeport-proxy
      path: config/nodeport-proxy/
    - name: minio
      namespace: minio
      path: config/minio/
    - name: nginx
      namespace: ingress-nginx
      path: config/nginx-ingress-controller/
    - name: oauth
      namespace: oauth
      path: config/oauth/
    - name: cert-manager
      namespace: cert-manager
      path: config/cert-manager/
    - name: certs
      namespace: default
      path: config/certs/
    - name: iap
      namespace: iap
      path: config/iap/
    - name: node-exporter
      namespace: monitoring
      path: config/monitoring/node-exporter/
    - name: kube-state-metrics
      namespace: monitoring
      path: config/monitoring/kube-state-metrics/
    - name: grafana
      namespace: monitoring
      path: config/monitoring/grafana/
    - name: alertmanager
      namespace: monitoring
      path: config/monitoring/alertmanager/
    - name: prometheus
      namespace: monitoring
      path: config/monitoring/prometheus/
    - name: elasticsearch
      namespace: logging
      path: config/logging/elasticsearch/
    - name: fluentd
      namespace: logging
      path: config/logging/fluentd/
    - name: kibana
      namespace: logging
      path: config/logging/kibana/
    # depends on 'kubermatic-docker-master' step to build the images
    helm: upgrade --install --wait --timeout 300 --tiller-namespace=kubermatic-installer
      --set=kubermatic.controller.image.tag=${DRONE_COMMIT}
      --set=kubermatic.api.image.tag=${DRONE_COMMIT}
      --set=kubermatic.rbac.image.tag=${DRONE_COMMIT}
    image: kubeciio/helm
    pull: true
    secrets:
    - source: kubeconfig_dev
      target: kubeconfig
    - source: values_dev
      target: values
    values:
    - values
    when:
      branch: master
  deploy-cloud-asia:
    charts:
    - name: kubermatic
      namespace: kubermatic
      path: config/kubermatic/
    - name: nodeport-proxy
      namespace: nodeport-proxy
      path: config/nodeport-proxy/
    - name: minio
      namespace: minio
      path: config/minio/
    - name: elasticsearch
      namespace: logging
      path: config/logging/elasticsearch/
    - name: fluentd
      namespace: logging
      path: config/logging/fluentd/
    - name: kibana
      namespace: logging
      path: config/logging/kibana/
    group: deploy-cloud
    # depends on 'kubermatic-docker-master' step to build the images
    helm: upgrade --install --wait --timeout 300 --kube-context=asia-east1-a-1 --tiller-namespace=kubermatic-installer
      --set=kubermatic.isMaster=false
      --set=kubermatic.controller.image.tag=${DRONE_COMMIT_SHA}
      --set=kubermatic.api.image.tag=${DRONE_COMMIT_SHA}
      --set=kubermatic.rbac.image.tag=${DRONE_COMMIT_SHA}
    image: kubeciio/helm
    pull: true
    secrets:
    - source: kubeconfig_cloud
      target: kubeconfig
    - source: values_cloud_as
      target: values
    values:
    - values
    when:
      branch: master
  deploy-cloud-europe:
    charts:
    - name: kubermatic
      namespace: kubermatic
      path: config/kubermatic/
    - name: nodeport-proxy
      namespace: nodeport-proxy
      path: config/nodeport-proxy/
    - name: minio
      namespace: minio
      path: config/minio/
    - name: nginx
      namespace: ingress-nginx
      path: config/nginx-ingress-controller/
    - name: oauth
      namespace: oauth
      path: config/oauth/
    - name: cert-manager
      namespace: cert-manager
      path: config/cert-manager/
    - name: certs
      namespace: default
      path: config/certs/
    - name: iap
      namespace: iap
      path: config/iap/
    - name: node-exporter
      namespace: monitoring
      path: config/monitoring/node-exporter/
    - name: kube-state-metrics
      namespace: monitoring
      path: config/monitoring/kube-state-metrics/
    - name: grafana
      namespace: monitoring
      path: config/monitoring/grafana/
    - name: alertmanager
      namespace: monitoring
      path: config/monitoring/alertmanager/
    - name: prometheus
      namespace: monitoring
      path: config/monitoring/prometheus/
    - name: elasticsearch
      namespace: logging
      path: config/logging/elasticsearch/
    - name: fluentd
      namespace: logging
      path: config/logging/fluentd/
    - name: kibana
      namespace: logging
      path: config/logging/kibana/
    group: deploy-cloud
    # depends on 'kubermatic-docker-master' step to build the images
    helm: upgrade --install --wait --timeout 300 --kube-context=europe-west3-c-1 --tiller-namespace=kubermatic-installer
      --set=kubermatic.controller.image.tag=${DRONE_COMMIT_SHA}
      --set=kubermatic.api.image.tag=${DRONE_COMMIT_SHA}
      --set=kubermatic.rbac.image.tag=${DRONE_COMMIT_SHA}
    image: kubeciio/helm
    pull: true
    secrets:
    - source: kubeconfig_cloud
      target: kubeconfig
    - source: values_cloud_eu
      target: values
    values:
    - values
    when:
      branch: master
  deploy-cloud-us:
    charts:
    - name: kubermatic
      namespace: kubermatic
      path: config/kubermatic/
    - name: nodeport-proxy
      namespace: nodeport-proxy
      path: config/nodeport-proxy/
    - name: minio
      namespace: minio
      path: config/minio/
    - name: elasticsearch
      namespace: logging
      path: config/logging/elasticsearch/
    - name: fluentd
      namespace: logging
      path: config/logging/fluentd/
    - name: kibana
      namespace: logging
      path: config/logging/kibana/
    group: deploy-cloud
    # depends on 'kubermatic-docker-master' step to build the images
    helm: upgrade --install --wait --timeout 300 --kube-context=us-central1-c-1 --tiller-namespace=kubermatic-installer
      --set=kubermatic.isMaster=false
      --set=kubermatic.controller.image.tag=${DRONE_COMMIT_SHA}
      --set=kubermatic.api.image.tag=${DRONE_COMMIT_SHA}
      --set=kubermatic.rbac.image.tag=${DRONE_COMMIT_SHA}
    image: kubeciio/helm
    pull: true
    secrets:
    - source: kubeconfig_cloud
      target: kubeconfig
    - source: values_cloud_us
      target: values
    values:
    - values
    when:
      branch: master
  deploy-run:
    charts:
    - name: kubermatic
      namespace: kubermatic
      path: config/kubermatic/
    - name: nodeport-proxy
      namespace: nodeport-proxy
      path: config/nodeport-proxy/
    - name: minio
      namespace: minio
      path: config/minio/
    - name: nginx
      namespace: ingress-nginx
      path: config/nginx-ingress-controller/
    - name: oauth
      namespace: oauth
      path: config/oauth/
    - name: cert-manager
      namespace: cert-manager
      path: config/cert-manager/
    - name: certs
      namespace: default
      path: config/certs/
    - name: iap
      namespace: iap
      path: config/iap/
    - name: node-exporter
      namespace: monitoring
      path: config/monitoring/node-exporter/
    - name: kube-state-metrics
      namespace: monitoring
      path: config/monitoring/kube-state-metrics/
    - name: grafana
      namespace: monitoring
      path: config/monitoring/grafana/
    - name: alertmanager
      namespace: monitoring
      path: config/monitoring/alertmanager/
    - name: prometheus
      namespace: monitoring
      path: config/monitoring/prometheus/
    - name: elasticsearch
      namespace: logging
      path: config/logging/elasticsearch/
    - name: fluentd
      namespace: logging
      path: config/logging/fluentd/
    - name: kibana
      namespace: logging
      path: config/logging/kibana/
    # depends on 'kubermatic-docker-release-v28' step to build the images
    helm: upgrade --install --wait --timeout 300
      --set=kubermatic.controller.image.tag=${DRONE_COMMIT_SHA}
      --set=kubermatic.api.image.tag=${DRONE_COMMIT_SHA}
      --set=kubermatic.rbac.image.tag=${DRONE_COMMIT_SHA}
    image: kubeciio/helm
    pull: true
    secrets:
    - source: kubeconfig_run
      target: kubeconfig
    - source: values_run
      target: values
    values:
    - values
    when:
      branch: release/v2.8
  slack:
    channel: dev
    group: slack
    icon_url: https://avatars2.githubusercontent.com/u/2181346?v=4&s=200
    image: kubermaticbot/drone-slack
    pull: true
    template: '${DRONE_COMMIT_AUTHOR} deployed a new API & Controller to dev & cloud.
      :heart:'
    username: drone
    webhook: https://hooks.slack.com/services/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
    when:
      branch: master
      status:
      - success
  slack-failure:
    author_recipient_mapping:
    - alvaroaleman=alvaro
    - cbrgm=christian
    - glower=igor.komlew
    - guusvw=guus
    - j3ank=eugenia
    - kdomanski=kamil
    - kgroschoff=kristin.groschoff
    - kron4eg=artiom
    - mrIncompetent=henrik
    - p0lyn0mial=lukasz
    - pkavajin=patrick
    - scheeles=sebastian
    - thz=tobias.hintze
    - toschneck=tobias.schneck
    - xrstf=christoph
    - xmudrii=marko
    - maciaszczykm=marcin
    - floreks=sebastian.florek
    group: slack
    icon_url: https://avatars2.githubusercontent.com/u/2181346?v=4&s=200
    image: kubermaticbot/drone-slack
    image_url: https://media.giphy.com/media/m6tmCnGCNvTby/giphy-downsized.gif
    pull: true
    recipient: ${DRONE_COMMIT_AUTHOR}
    template: |-
      Your build failed! Shame. Shame. Shame.
            ${DRONE_BUILD_LINK}
    username: drone
    webhook: https://hooks.slack.com/services/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
    when:
      status:
      - failure
workspace:
  base: /go
  path: src/github.com/kubermatic/kubermatic
