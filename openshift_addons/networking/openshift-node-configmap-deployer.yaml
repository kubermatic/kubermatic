kind: DaemonSet
apiVersion: apps/v1
metadata:
  name: create-node-config
  namespace: openshift-sdn
spec:
  selector:
    matchLabels:
      app: create-bind-mounts
  template:
    metadata:
      labels:
        app: create-bind-mounts
    spec:
      hostPID: true
      serviceAccount: sdn
      serviceAccountName: sdn
      hostNetwork: true
      containers:
      - name: startup-script
        image: '{{ Registry "quay.io" }}/kubermatic/startup-script:v0.1.0'
        securityContext:
          privileged: true
        env:
        ## This is only needed because the `sdn` daemonset wont start without this file being preset
        ## It is not deployed via the machine-controller because the machine-controller doesn't know
        ## the pod cidr. Also the whole thing feels very redundant, because there is a resource
        ## clusternetwork.v1.network.openshift.io created for the network configured in the control plane
        ## TODO: Figure out which parts of this config file are actually needed and remove everythiing else
        - name: STARTUP_SCRIPT
          value: |
            cat <<EOF >/etc/origin/node/node-config.yaml
            apiVersion: v1
            authConfig:
              authenticationCacheSize: 1000
              authenticationCacheTTL: 5m
              authorizationCacheSize: 1000
              authorizationCacheTTL: 5m
            dnsBindAddress: 127.0.0.1:53
            dnsDomain: cluster.local
            dnsIP: 0.0.0.0
            dnsNameservers: null
            dnsRecursiveResolvConf: /etc/origin/node/resolv.conf
            dockerConfig:
              dockerShimRootDirectory: /var/lib/dockershim
              dockerShimSocket: /var/run/dockershim.sock
              execHandlerName: native
            enableUnidling: true
            imageConfig:
              format: docker.io/openshift/origin-\${component}:\${version}
              latest: false
            iptablesSyncPeriod: 30s
            kind: NodeConfig
            kubeletArguments:
              bootstrap-kubeconfig:
              - /etc/origin/node/bootstrap.kubeconfig
              cert-dir:
              - /etc/origin/node/certificates
              enable-controller-attach-detach:
              - 'true'
              feature-gates:
              - RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true
              node-labels:
              - node-role.kubernetes.io/master=true,node-role.kubernetes.io/infra=true
              pod-manifest-path:
              - /etc/origin/node/pods
              rotate-certificates:
              - 'true'
            masterClientConnectionOverrides:
              acceptContentTypes: application/vnd.kubernetes.protobuf,application/json
              burst: 40
              contentType: application/vnd.kubernetes.protobuf
              qps: 20
            masterKubeConfig: node.kubeconfig
            networkConfig:
              mtu: 1450
              networkPluginName: redhat/openshift-ovs-subnet
            proxyArguments:
              cluster-cidr:
              # TODO: Softcode/template this
              - 172.25.0.0/16
            servingInfo:
              bindAddress: 0.0.0.0:10250
              bindNetwork: tcp4
              clientCA: client-ca.crt
            volumeConfig:
              localQuota:
                perFSGroup: null
            volumeDirectory: /var/lib/origin/openshift.local.volumes
            EOF
