apiVersion: "nodeset.k8s.io/v1alpha1"
kind: NodeClass
metadata:
  name: {{ .Name }}
nodeController: kube-machine
config:
  dockerMachineFlags:
    openstack-auth-url: "{{ .Datacenter.Spec.Openstack.AuthURL }}"
    openstack-availability-zone: "{{ .Datacenter.Spec.Openstack.AvailabilityZone }}"
    openstack-flavor-name: "{{ .NodeSpec.Openstack.Flavor }}"
    openstack-domain-name: "{{ .Cluster.Spec.Cloud.Openstack.Domain }}"
    openstack-floatingip-pool: "{{ .Cluster.Spec.Cloud.Openstack.FloatingIPPool }}"
    openstack-image-name: "{{ .NodeSpec.Openstack.Image }}"
    openstack-password: "{{ .Cluster.Spec.Cloud.Openstack.Password }}"
    openstack-username: "{{ .Cluster.Spec.Cloud.Openstack.Username }}"
    openstack-tenant-name: "{{ .Cluster.Spec.Cloud.Openstack.Tenant }}"
    openstack-net-name: "{{ .Cluster.Spec.Cloud.Openstack.Network }}"
    openstack-sec-groups: "{{ .Cluster.Spec.Cloud.Openstack.SecurityGroups }}"
    openstack-ssh-user: "ubuntu"
  provider: openstack
  provisioning:
    users:
      - name: "apiserver"
        ssh_keys:
          - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDRPD+jFtDSjuoMc/Wh8gxJ34y6PCaePyeDnDF4lTrJDc1riej9rGmYPdwzirqn3il+v3Lt802HTfbhuzELqcgad6gnisjpPa0xffwZPhulQLYPZp6FQ18FPvQBSDGy8VU3OUWr1AcntTQ0BUvAmYFoKrsjRPeix/LrvSAgOY+dDmgHus4vb37WmqyH23izUNYxMrYcmG3RM0Qnog2C2JGWd8w2pN6huB1CXN8ab06amRuBfYbwabSofxyxmgEpm1jBYkhKEwSM302z7lWxKgu3FXaUeg/o954NYv69vW/vf9+KRPI3iM0uXrmHg5zjtgd1uifTUVBZ044FL9HjiQdv Sebastian@macbook.fritz.box"
          - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC496PqMk7zZuQKXpzcgl3g92LNZMcgEgkfnj4BNoa2CRs5f4wrHMt1Ii78CgY3Ziqw4y191v6IJ3Fby2gT26YWIaK6qSF35sXmjyG/MH+Iu96wIn7JcjlnTkizofGE7zOkRmEtMYcyOVbgnwEH4UNj1W1aalton5JCAqz8kFpKE7sp/2NpxZMqgO68NaqYSd0nDXdwM9HX1grWVF88lBXEJ5YSF03sEpnsOyw0QHhXHyNwHOpfL/wCG0/8OWel1dcXOeQKVVp5V045er0AyIFJVwHSTQCnfyKYCf5i0cLci4+61iSS1hBSl2qBqz6z6mdLy8O7XSP9kPoyQarnQguFO+DHOG8IyTP/Kk3PC/+yR8xGfhFxqM8fGdSdrRwpIgjGH0/7or1vbbUvp52evRMZIdT1YfndahRxafo0iZ36o+VgX1W5oWiZ8Bws/zrV2PCqrmuEbFYSpLati3XvxRQG+Om5p7dzdXx1mb86wqyNe4xpZ2gVInaUYINnwcUmLiaOtCHh4tE/RBMqjcRY7i75gl29H8nbDFwWHGLTULix1W+1FH0XyPiL831XdECYSlw8h+kJW/fYtlynTgeYSLSrIA0atEblf1ui0BPnd8imFX7h8mlUhPgxpfxasI+EQj+m4xjeJUalHTvFuE1wqls8A7A6+J8HP/Ol9cOlDFxexw== henrik@loodse.com"
          - "{{ .Cluster.Status.ApiserverSSHKey.PublicKey | apiBytesToString }} apiserver@{{ .Cluster.Address.ExternalName }}"
        sudo: true
    commands:
      - "sudo systemctl start download-kubelet.service"
      - "sudo systemctl enable kubelet && sudo systemctl start kubelet"
    files:
      - path: "/etc/kubernetes/bootstrap.kubeconfig"
        permissions: "0640"
        owner: "root"
        content: |-
{{ .Kubeconfig | indent 10 }}
      - path: "/etc/systemd/system/download-kubelet.service"
        permissions: "0640"
        owner: "root"
        content: |-
          [Unit]
          Description=Download Kubelet and requirements
          After=network.target

          [Service]
          Type=oneshot
          ExecStartPre=/bin/mkdir -p /opt/bin /opt/cni/bin /etc/cni/net.d /var/run/kubernetes /var/lib/kubelet /etc/kubernetes/manifests /var/log/containers
          ExecStartPre=/bin/bash -c "/usr/bin/curl -L -o /tmp/cni-amd64.tgz https://github.com/containernetworking/cni/releases/download/v0.5.2/cni-amd64-v0.5.2.tgz && tar -xvf /tmp/cni-amd64.tgz -C /opt/cni/bin/"
          ExecStartPre=/usr/bin/curl -L -o /opt/bin/socat https://s3-eu-west-1.amazonaws.com/kubermatic/coreos/socat
          ExecStartPre=/bin/chmod +x /opt/bin/socat
          ExecStart=/usr/bin/curl -L -o /opt/bin/kubelet https://storage.googleapis.com/kubelet/kubelet.v1.6.7
          ExecStartPost=/bin/chmod +x /opt/bin/kubelet
          RemainAfterExit=true

          [Install]
          WantedBy=multi-user.target

      - path: "/etc/systemd/system/kubelet.service"
        permissions: "0640"
        owner: "root"
        content: |-
          [Unit]
          Description=Kubelet
          Requires=network.target download-kubelet.service
          After=network.target download-kubelet.service

          [Service]
          Restart=always
          RestartSec=10
          Environment="PATH=/sbin:/bin:/usr/sbin:/usr/bin:/opt/bin"
          ExecStart=/opt/bin/kubelet \
            --api-servers={{.Cluster.Address.URL}} \
            --container-runtime=docker \
            --allow-privileged=true \
            --pod-manifest-path=/etc/kubernetes/manifests \
            --cni-conf-dir=/etc/cni/net.d \
            --network-plugin=cni \
            --cluster-dns=10.10.10.10 \
            --cluster_domain=cluster.local \
            --kubeconfig=/etc/kubernetes/kubeconfig \
            --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \
            --cert-dir=/etc/kubernetes/

          [Install]
          WantedBy=multi-user.target

      - path: "/etc/kubernetes/cloud-config"
        permissions: "0640"
        owner: "root"
        content: |-
          [Global]
          auth-url="{{ .Datacenter.Spec.Openstack.AuthURL }}"
          Username="{{ .Cluster.Spec.Cloud.Openstack.Username }}"
          password="{{ .Cluster.Spec.Cloud.Openstack.Password }}"
          domain-name="{{ .Cluster.Spec.Cloud.Openstack.Domain }}"
