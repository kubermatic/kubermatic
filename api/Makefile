REPO=kubermatic/api
GO?=go
CMD=kubermatic-api kubermatic-controller-manager kubermatic-controller-manager-cleanup client image-loader
GOBUILDFLAGS += -i -v
LDFLAGS += -extldflags '-static'
GITTAG=$(shell git describe --tags --always)
TAGS?=$(GITTAG)
DOCKERTAGS=$(TAGS) latestbuild
DOCKER_BUILD_FLAG += $(foreach tag, $(DOCKERTAGS), -t $(REPO):$(tag))
HAS_GOMETALINTER:= $(shell command -v gometalinter 2> /dev/null)
HAS_DEP:= $(shell command -v dep 2> /dev/null)
HAS_GIT:= $(shell command -v git 2> /dev/null)

default: all

all: check test build

build: $(CMD)

$(CMD): vendor
	$(GO) build $(GOBUILDFLAGS) -ldflags '-w $(LDFLAGS)' -o _build/$@ github.com/kubermatic/kubermatic/api/cmd/$@

check: gofmt lint
test: vendor
	@$(GO) test -v ./...

clean:
	@cd _build
	@rm -f $(CMD)
	@echo "Cleaned _build"

install: vendor
	@for PRODUCT in $(CMD); do \
		$(GO) install -v -ldflags '-w $(LDFLAGS)' github.com/kubermatic/kubermatic/api/cmd/$$PRODUCT ; \
	done

docker-build:
	docker build $(DOCKER_BUILD_FLAG) .

docker-push:
	@for tag in $(DOCKERTAGS) ; do \
		echo "docker push $(REPO):$$tag"; \
		docker push $(REPO):$$tag; \
	done

e2e: client-up
	docker run -it -v  $(CURDIR)/_artifacts/kubeconfig:/workspace/kubermatickubeconfig kubermatic/e2e-conformance:1.6

vendor:
ifndef HAS_GIT
	$(error You must install git)
endif
ifndef HAS_DEP
	go get -u github.com/golang/dep/cmd/dep
endif
	dep ensure

client-up:
	mkdir -p $(CURDIR)/_artifacts
	docker run -v $(CURDIR)/_artifacts/:/_artifacts -it $(REPO):latestbuild /client up

client-down:
	docker run -it $(REPO):latestbuild /client purge

gittag:
	@echo $(GITTAG)

GFMT=find . -not \( \( -wholename "./vendor" \) -prune \) -name "*.go" | xargs gofmt -l
gofmt:
	@UNFMT=$$($(GFMT)); if [ -n "$$UNFMT" ]; then echo "gofmt needed on" $$UNFMT && exit 1; fi
fix:
	@UNFMT=$$($(GFMT)); if [ -n "$$UNFMT" ]; then echo "goimports -w" $$UNFMT; goimports -w $$UNFMT; fi

lint:
ifndef HAS_GOMETALINTER
	go get -u github.com/alecthomas/gometalinter
	gometalinter --install
endif
	{ \
	set -e ;\
	PACKAGES=$$(go list ./... | grep -v /vendor/ | grep -v /api/pkg/crd/) ;\
	echo "go vet" ;\
	go vet $$PACKAGES ;\
	echo "golint" ;\
	golint -set_exit_status $$PACKAGES ;\
	echo "errcheck -blank" ;\
	errcheck -exclude errcheck_excludes.txt -blank $$PACKAGES ;\
	echo "varcheck" ;\
	varcheck $$PACKAGES ;\
	echo "structcheck" ;\
	structcheck $$PACKAGES ;\
	echo "gosimple" ;\
	gosimple $$PACKAGES ;\
	echo "unused" ;\
	unused $$PACKAGES ;\
	GOFILES=$$(find . -type f -name '*.go' -not -path "./vendor/*") ;\
	echo "misspell -error -locale US" ;\
	misspell -error -locale US $$GOFILES ;\
	}

cover:
	./hack/cover.sh --html

run-controller-manager: kubermatic-controller-manager
	./hack/run-controller.sh

run-api-server: kubermatic-api
	./hack/run-api.sh

.PHONY: build test check cover e2e-build client-build client-down client-up e2e docker-build docker-push run-controller-manager run-api-server $(CMD)
