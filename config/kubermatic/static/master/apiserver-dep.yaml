apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: apiserver
spec:
  selector:
    matchLabels:
      role: apiserver
      version: v1
  replicas: 1
  template:
    metadata:
      labels:
        role: apiserver
        release: {{index .Version.Values "k8s-version"}}
        version: v1
      annotations:
        prometheus.io/port: '8080'
        prometheus.io/scrape: 'true'
    spec:
      containers:
      - name: apiserver
        image: gcr.io/google_containers/hyperkube:{{index .Version.Values "k8s-version"}}
        command: [ "/hyperkube", "apiserver",
            "--advertise-address={{ .AdvertiseAddress }}",
            "--secure-port={{ .Cluster.Address.ApiserverExternalPort }}",
            "--kubernetes-service-node-port={{ .Cluster.Address.ApiserverExternalPort }}",
            "--insecure-bind-address=0.0.0.0",
            "--insecure-port=8080",
            "--external-hostname=apiserver",
            "--etcd-servers=http://etcd-cluster-client:2379",
            "--storage-backend=etcd3",
            "--admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota",
            "--authorization-mode=AlwaysAllow",
            "--anonymous-auth=false",
            "--token-auth-file=/var/run/kubernetes/token-users/file",
            "--service-account-key-file=/var/run/kubernetes/auth/service-account.key",
            "--service-cluster-ip-range=10.10.10.0/24",
            "--service-node-port-range=30000-32767",
            "--allow-privileged",
            "--tls-cert-file=/var/run/kubernetes/auth/apiserver.crt",
            "--tls-private-key-file=/var/run/kubernetes/auth/apiserver.key",
            "--client-ca-file=/var/run/kubernetes/auth/root-ca.crt",
            "--kubelet-client-certificate=/var/run/kubernetes/auth/kubelet-client.crt",
            "--kubelet-client-key=/var/run/kubernetes/auth/kubelet-client.key",
            {{ if eq .CloudProvider "aws" }}
            "--kubelet-preferred-address-types=ExternalIP,Hostname,InternalIP,LegacyHostIP",
            {{ else }}
            "--kubelet-preferred-address-types=InternalIP,Hostname,ExternalIP,LegacyHostIP",
            {{ end }}
            "--ssh-keyfile=/var/run/kubernetes/ssh/id-rsa",
            "--ssh-user=apiserver",
            "--v=4" ]
        resources:
          limits:
            memory: 200Mi
        ports:
        - containerPort: {{ .Cluster.Address.ApiserverExternalPort }}
        - containerPort: 8080
        volumeMounts:
        - name: auth
          mountPath: /var/run/kubernetes/auth
          readOnly: true
        - name: token-users
          mountPath: /var/run/kubernetes/token-users
          readOnly: true
        - name: ssh
          mountPath: /var/run/kubernetes/ssh
          readOnly: true
      volumes:
      - name: auth
        secret:
          secretName: apiserver-auth
      - name: token-users
        secret:
          secretName: token-users
      - name: ssh
        secret:
          secretName: apiserver-ssh
          defaultMode: 0400
