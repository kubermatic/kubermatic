apiVersion: "machine.k8s.io/v1alpha1"
kind: Machine
metadata:
  name: machine-{{ .Node.Metadata.Name }}
spec:
  metadata:
    name: {{ .Node.Metadata.Name }}
  providerConfig:
    sshPublicKeys:
      {{ range .Keys }}- {{ .Spec.PublicKey }}
      {{ end }}
    {{- if .Node.Spec.Cloud.AWS }}
    cloudProvider: aws
    cloudProviderSpec:
      region: {{ .Datacenter.Spec.AWS.Region }}
      availabilityZone: {{ print .Datacenter.Spec.AWS.Region .Datacenter.Spec.AWS.ZoneCharacter | quote }}
      vpcId: {{ .Cluster.Spec.Cloud.AWS.VPCID | quote }}
      subnetId: {{ .Cluster.Spec.Cloud.AWS.SubnetID | quote }}
      instanceProfile: {{ .Cluster.Spec.Cloud.AWS.InstanceProfileName | quote }}
      securityGroupIDs:
      - {{ .Cluster.Spec.Cloud.AWS.SecurityGroupID | quote }}
      instanceType: {{ .Node.Spec.Cloud.AWS.InstanceType | quote }}
      diskSize: {{ default 25 .Node.Spec.Cloud.AWS.VolumeSize }}
      diskType: {{ default "gp2" .Node.Spec.Cloud.AWS.VolumeType | quote }}
      ami: {{ .Node.Spec.Cloud.AWS.AMI | quote }}
      tags:
        KubernetesCluster: {{ .Cluster.Name | quote }}
        {{- range $key, $value := .Node.Spec.Cloud.AWS.Tags }}
        {{$key | quote }}: {{$value | quote }}
        {{- end }}
    {{- end }}
    {{- if .Node.Spec.Cloud.Openstack }}
    cloudProvider: openstack
    cloudProviderSpec:
      region: {{ .Datacenter.Spec.Openstack.Region | quote }}
      image: {{ .Node.Spec.Cloud.Openstack.Image | quote }}
      flavor: {{ .Node.Spec.Cloud.Openstack.Flavor | quote }}
      securityGroups:
        - {{ .Cluster.Spec.Cloud.Openstack.SecurityGroups | quote }}
      floatingIpPool: {{ .Cluster.Spec.Cloud.Openstack.FloatingIPPool | quote }}
      availabilityZone: {{ .Datacenter.Spec.Openstack.AvailabilityZone | quote }}
      network: {{ .Cluster.Spec.Cloud.Openstack.Network | quote }}
    {{- end }}
    {{- if .Node.Spec.Cloud.Digitalocean }}
    cloudProvider: digitalocean
    cloudProviderSpec:
      region: {{ .Datacenter.Spec.Digitalocean.Region | quote }}
      size: {{ .Node.Spec.Cloud.Digitalocean.Size }}
      backups: {{ .Node.Spec.Cloud.Digitalocean.Backups }}
      ipv6: {{ .Node.Spec.Cloud.Digitalocean.IPv6 }}
      private_networking: true
      monitoring: {{ .Node.Spec.Cloud.Digitalocean.Monitoring }}
      tags:
      - kubermatic
      - {{ print "kubermatic-cluster-" .Cluster.Name | quote }}
      {{ range .Node.Spec.Cloud.Digitalocean.Tags }}- {{ . | quote }}
      {{ end }}
    {{- end }}
    {{- if .Node.Spec.Cloud.Hetzner }}
    cloudProvider: hetzner
    cloudProviderSpec:
      serverType: {{ .Node.Spec.Cloud.Hetzner.Type | quote }}
      datacenter: {{ .Datacenter.Spec.Hetzner.Datacenter | quote }}
      location: {{ .Datacenter.Spec.Hetzner.Location | quote }}
    {{- end }}
    {{- if .Node.Spec.Cloud.VSphere }}
    cloudProvider: vsphere
    cloudProviderSpec:
    {{- if .Node.Spec.OperatingSystem.Ubuntu }}
      templateVMName: {{ default "ubuntu-template" .Node.Spec.Cloud.VSphere.Template | quote }}
    {{- end }}
    {{- if .Node.Spec.OperatingSystem.ContainerLinux }}
      templateVMName: {{ default "coreos_production_vmware_ova" .Node.Spec.Cloud.VSphere.Template | quote }}
    {{- end }}
      username: {{ .Cluster.Spec.Cloud.VSphere.Username | quote }}
      password: {{ .Cluster.Spec.Cloud.VSphere.Password | quote }}
      vsphereURL: {{ .Datacenter.Spec.VSphere.Endpoint | quote }}
      datacenter: {{ .Datacenter.Spec.VSphere.Datacenter | quote }}
      datastore: {{ .Datacenter.Spec.VSphere.Datastore | quote }}
      cluster: {{ .Datacenter.Spec.VSphere.Cluster | quote }}
      allowInsecure: {{ .Datacenter.Spec.VSphere.AllowInsecure }}
      cpus: {{ .Node.Spec.Cloud.VSphere.CPUs }}
      memoryMB: {{ .Node.Spec.Cloud.VSphere.Memory }}
    {{- end }}
    {{- if .Node.Spec.OperatingSystem.ContainerLinux }}
    operatingSystem: coreos
    operatingSystemSpec:
      disableAutoUpdate: {{ .Node.Spec.OperatingSystem.ContainerLinux.DisableAutoUpdate }}
    {{- end }}
    {{- if .Node.Spec.OperatingSystem.Ubuntu }}
    operatingSystem: ubuntu
    operatingSystemSpec:
      distUpgradeOnBoot: {{ .Node.Spec.OperatingSystem.Ubuntu.DistUpgradeOnBoot }}
    {{- end }}
  roles:
  - Node
  versions:
    kubelet: {{ .Node.Spec.Versions.Kubelet | quote }}
    containerRuntime:
      name: {{ .Node.Spec.Versions.ContainerRuntime.Name | quote }}
      version: {{ .Node.Spec.Versions.ContainerRuntime.Version | quote }}
