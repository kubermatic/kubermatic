apiVersion: extensions/v1beta1
{{ if .Values.IsBareMetal }}
kind: DaemonSet
{{ else }}
kind: Deployment
{{ end }}
metadata:
  labels:
    role: k8sniff-ingress-lb
  name: k8sniff-ingress-lb
  namespace: k8sniff
spec:
{{ if .Values.IsBareMetal }}
{{ else }}
  replicas: {{ .Values.K8SniffReplicaCount }}
  selector:
    matchLabels:
      role: k8sniff-ingress-lb
{{ end }}
  template:
    metadata:
      labels:
        role: k8sniff-ingress-lb
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: "8085"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: k8sniff
    {{ if .Values.IsBareMetal }}
      hostNetwork: true
    {{ end }}
      containers:
      - command:
        - /bin/sh
        - -c
        - -x
        - /pipeline/source/k8sniff -logtostderr --v=4 --config /etc/config/k8sniff.json
        image: kubermatic/k8sniff:{{ .Values.K8sniffImageTag }}
        imagePullPolicy: Always
        name: k8sniff-ingress-lb
        {{ if not .Values.IsBareMetal }}
        ports:
        - containerPort: 8443
          name: https
        - containerPort: 8085
          name: metrics
        {{ end }}
        volumeMounts:
        - mountPath: /etc/config
          name: k8sniff-config
          readOnly: true
      imagePullSecrets:
      - name: dockercfg
      volumes:
      - configMap:
          name: k8sniff-configmap
        name: k8sniff-config
