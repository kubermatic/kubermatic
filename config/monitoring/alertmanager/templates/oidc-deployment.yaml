{{- if .Values.alertmanager.auth_settings.oidc.enabled -}}
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: alertmanager-kubermatic-oidc-proxy
  labels:
    app: alertmanager-kubermatic-oidc-proxy
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: alertmanager-kubermatic-oidc-proxy
    spec:
      containers:
      - image: {{ . Values.alertmanager.keycloak_proxy_image }}:{{ . Values.alertmanager.keycloak_proxy_version }}
        name: keycloak-proxy
        args:
        - --discovery-url={{ .Values.alertmanager.auth_settings.oidc.discovery_url | quote }}
        - --redirection-url={{ .Values.alertmanager.auth_settings.oidc.redirection_url | quote }}
        - --listen=0.0.0.0:3000
        - --upstream-url=http://alertmanager-kubermatic:9093
        - --enable-refresh-tokens=true
        - --resources=uri=/*
        envFrom:
        - secretRef:
            name: alertmanager-kubermatic-oidc
        ports:
        - containerPort: 3000
          name: web
        livenessProbe:
          httpGet:
            path: /oauth/health
            port: 3000
          initialDelaySeconds: 3
          timeoutSeconds: 2
        readinessProbe:
          httpGet:
            path: /oauth/health
            port: 3000
          initialDelaySeconds: 3
          timeoutSeconds: 2
      securityContext:
        fsGroup: 2000
        runAsNonRoot: true
        runAsUser: 1000
{{- end -}}
