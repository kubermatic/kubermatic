.PHONY: prometheus
prometheus: rules check

.PHONY: rules
rules:
	$(eval header="\# This file was generated by running \`make rules\`.")
	(echo "${header}"; jsonnet -J vendor -e 'std.manifestYamlDoc((import "prometheus/jsonnet/prometheus.jsonnet").output)' -S) | sed 's/[[:space:]]*$$//' > prometheus/rules/rules.yaml

.PHONY: check-config check-rules
check: check-config check-rules

check-config:
	promtool check config prometheus/config/prometheus.yml

check-rules:
	promtool check rules prometheus/rules/rules.yaml

.PHONY: format-dashboards
format-dashboards:
	find grafana/dashboards -name '*.json' -exec sh -c "jq --sort-keys '.' {} > {}.tmp && mv {}.tmp {}" \;
