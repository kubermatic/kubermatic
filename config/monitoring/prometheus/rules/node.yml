groups:
- name: node
  rules:
  - record: instance:node_cpu:rate:sum
    expr: sum(rate(node_cpu{mode!="idle",mode!="iowait",mode!~"^(?:guest.*)$"}[3m])) BY (instance)
  - record: instance:node_filesystem_usage:sum
    expr: sum((node_filesystem_size{mountpoint="/"} - node_filesystem_free{mountpoint="/"})) BY (instance)
  - record: instance:node_network_receive_bytes:rate:sum
    expr: sum(rate(node_network_receive_bytes[3m])) BY (instance)
  - record: instance:node_network_transmit_bytes:rate:sum
    expr: sum(rate(node_network_transmit_bytes[3m])) BY (instance)
  - record: instance:node_cpu:ratio
    expr: sum(rate(node_cpu{mode!="idle"}[5m])) WITHOUT (cpu, mode) / ON(instance) GROUP_LEFT() count(sum(node_cpu) BY (instance, cpu)) BY (instance)
  - record: cluster:node_cpu:sum_rate5m
    expr: sum(rate(node_cpu{mode!="idle"}[5m]))
  - record: cluster:node_cpu:ratio
    expr: cluster:node_cpu:rate5m / count(sum(node_cpu) BY (instance, cpu))

  - alert: NodeExporterDown
    expr: absent(up{job="node-exporter"} == 1)
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Prometheus could not scrape a node-exporter"
      description: "Prometheus could not scrape a node-exporter for more than 10m, or node-exporters have disappeared from discovery."
  - alert: KubernetesNodeOutOfDisk
    expr: kube_node_status_condition{condition="OutOfDisk",status="true"} == 1
    labels:
      severity: critical
    annotations:
      summary: "Node ran out of disk space"
      description: '{{ $labels.node }} has run out of disk space.'
  - alert: KubernetesNodeMemoryPressure
    expr: kube_node_status_condition{condition="MemoryPressure",status="true"} == 1
    labels:
      severity: warning
    annotations:
      summary: "Node is under memory pressure"
      description: '{{ $labels.node }} is under memory pressure.'
  - alert: KubernetesNodeDiskPressure
    expr: kube_node_status_condition{condition="DiskPressure",status="true"} == 1
    labels:
      severity: warning
    annotations:
      summary: "Node is under disk pressure"
      description: '{{ $labels.node }} is under disk pressure.'
  - alert: NodeDiskWillFillIn4Hours
    expr: predict_linear(node_filesystem_free{job="node-exporter"}[1h], 4 * 3600) < 0
    for: 15m
    labels:
      severity: page
    annotations:
      description: "Device {{ $labels.device }} of instance {{ $labels.instance }} is filling quickly."
      summary: "Disk will fill in 4 hours"
  - alert: NodeDiskWillFillIn8Hours
    expr: predict_linear(node_filesystem_free{job="node-exporter"}[1h], 8 * 3600) < 0
    for: 15m
    labels:
      severity: notify
    annotations:
      description: "Device {{ $labels.device }} of instance {{ $labels.instance }} is filling quickly."
      summary: "Disk will fill in 4 hours"
