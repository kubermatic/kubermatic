groups:
- name: node-exporter
  rules:
  - alert: NodeFilesystemSpaceFillingUp
    annotations:
      message: >
        Filesystem on {{ $labels.device }} at {{ $labels.instance }} is predicted
        to run out of space within the next 24 hours.
    expr: |
      predict_linear(node_filesystem_avail{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"}[6h], 24*60*60) < 0
      and
      node_filesystem_avail{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} / node_filesystem_size{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} < 0.4
      and
      node_filesystem_readonly{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} == 0
    for: 1h
    labels:
      severity: warning

  - alert: NodeFilesystemSpaceFillingUp
    annotations:
      message: >
        Filesystem on {{ $labels.device }} at {{ $labels.instance }} is predicted
        to run out of space within the next 4 hours.
    expr: |
      predict_linear(node_filesystem_avail{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"}[6h], 4*60*60) < 0
      and
      node_filesystem_avail{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} / node_filesystem_size{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} < 0.2
      and
      node_filesystem_readonly{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} == 0
    for: 1h
    labels:
      severity: critical

  - alert: NodeFilesystemOutOfSpace
    annotations:
      message: >
        Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only
        {{ $value }}% available space left.
    expr: |
      node_filesystem_avail{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} / node_filesystem_size{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} * 100 < 5
      and
      node_filesystem_readonly{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} == 0
    for: 1h
    labels:
      severity: warning

  - alert: NodeFilesystemOutOfSpace
    annotations:
      message: >
        Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only
        {{ $value }}% available space left.
    expr: |
      node_filesystem_avail{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} / node_filesystem_size{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} * 100 < 3
      and
      node_filesystem_readonly{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} == 0
    for: 1h
    labels:
      severity: critical

  - alert: NodeFilesystemFilesFillingUp
    annotations:
      message: >
        Filesystem on {{ $labels.device }} at {{ $labels.instance }} is predicted
        to run out of files within the next 24 hours.
    expr: |
      predict_linear(node_filesystem_files_free{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"}[6h], 24*60*60) < 0
      and
      node_filesystem_files_free{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} / node_filesystem_files{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} < 0.4
      and
      node_filesystem_readonly{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} == 0
    for: 1h
    labels:
      severity: warning

  - alert: NodeFilesystemFilesFillingUp
    annotations:
      message: >
        Filesystem on {{ $labels.device }} at {{ $labels.instance }} is predicted
        to run out of files within the next 4 hours.
    expr: |
      predict_linear(node_filesystem_files_free{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"}[6h], 4*60*60) < 0
      and
      node_filesystem_files_free{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} / node_filesystem_files{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} < 0.2
      and
      node_filesystem_readonly{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} == 0
    for: 1h
    labels:
      severity: warning

  - alert: NodeFilesystemOutOfFiles
    annotations:
      message: >
        Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only
        {{ $value }}% available inodes left.
    expr: |
      node_filesystem_files_free{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} / node_filesystem_files{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} * 100 < 5
      and
      node_filesystem_readonly{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} == 0
    for: 1h
    labels:
      severity: warning

  - alert: NodeFilesystemOutOfSpace
    annotations:
      message: >
        Filesystem on {{ $labels.device }} at {{ $labels.instance }} has only
        {{ $value }}% available space left.
    expr: |
      node_filesystem_files_free{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} / node_filesystem_files{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} * 100 < 3
      and
      node_filesystem_readonly{app="node-exporter",fstype=~"ext.|xfs",mountpoint!="/var/lib/docker/aufs"} == 0
    for: 1h
    labels:
      severity: critical

  - alert: NodeNetworkReceiveErrs
    annotations:
      message: >
        {{ $labels.instance }} interface {{ $labels.device }} shows errors
        while receiving packets ({{ $value }} errors in two minutes).
    expr: increase(node_network_receive_errs[2m]) > 10
    for: 1h
    labels:
      severity: critical

  - alert: NodeNetworkTransmitErrs
    annotations:
      message: >
        {{ $labels.instance }} interface {{ $labels.device }} shows errors
        while transmitting packets ({{ $value }} errors in two minutes).
    expr: increase(node_network_transmit_errs[2m]) > 10
    for: 1h
    labels:
      severity: critical
