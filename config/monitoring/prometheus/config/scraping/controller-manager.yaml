job_name: controller-manager
scheme: https
tls_config:
  ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
kubernetes_sd_configs:
- role: pod
relabel_configs:
# drop everything within test clusters
- source_labels: [__meta_kubernetes_namespace]
  regex: prow-kubermatic-.*
  action: drop

# select only controller-managers
- source_labels: [__meta_kubernetes_pod_label_component]
  regex: kube-controller-manager
  action: keep

# tunnel through apiserver proxy
- target_label: __address__
  replacement: kubernetes.default.svc:443
- source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_pod_name]
  regex: (.+);(.+)
  target_label: __metrics_path__
  replacement: /api/v1/namespaces/${1}/pods/${2}:10252/proxy/metrics

# add readable labels
- regex: __meta_kubernetes_pod_label_(.+)
  action: labelmap
- source_labels: [__meta_kubernetes_namespace]
  regex: (.*)
  replacement: $1
  action: replace
  target_label: namespace
- source_labels: [__meta_kubernetes_pod_name]
  regex: (.*)
  replacement: $1
  action: replace
  target_label: pod
