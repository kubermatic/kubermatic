# Please keep kube-proxy configuration in-sync with:
# cluster/saltbase/salt/kube-proxy/kube-proxy.manifest

apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  labels:
    k8s-app: kube-proxy
    addonmanager.kubernetes.io/mode: "Reconcile"
  name: kube-proxy
  namespace: kube-system
spec:
  selector:
    matchLabels:
      k8s-app: kube-proxy
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 10%
  template:
    metadata:
      labels:
        k8s-app: kube-proxy
      annotations:
        scheduler.alpha.kubernetes.io/critical-pod: ''
    spec:
      initContainers:
      - name: copy-kubeconfig
        image: busybox
        command:
        - /bin/sh
        - -ec
        - "cp /etc/kubernetes/kubelet.conf /etc/kubernetes/kubeconfig & sleep 2"
        volumeMounts:
        - name: etc-kubernetes
          mountPath: /etc/kubernetes
      hostNetwork: true
      tolerations:
      - operator: "Exists"
        effect: "NoExecute"
      - operator: "Exists"
        effect: "NoSchedule"
      containers:
      - name: kube-proxy
        image: "gcr.io/google_containers/hyperkube-amd64:v1.9.2"
        command: [
          "/hyperkube",
          "proxy",
          "--v=4",
          "--kubeconfig=/etc/kubernetes/kubeconfig",
          "--cluster-cidr={{first .Cluster.Spec.ClusterNetwork.Pods.CIDRBlocks}}"
        ]
        securityContext:
          privileged: true
        volumeMounts:
        - mountPath: /var/log
          name: varlog
          readOnly: false
        - mountPath: /run/xtables.lock
          name: xtables-lock
          readOnly: false
        - mountPath: /lib/modules
          name: lib-modules
          readOnly: true
        - name: dbus
          mountPath: /var/run/dbus/system_bus_socket
          readOnly: false
        - name: etc-kubernetes
          mountPath: /etc/kubernetes
        - name: var-lib-kubelet-pki
          mountPath: /var/lib/kubelet/pki
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: xtables-lock
        hostPath:
          path: /run/xtables.lock
          type: FileOrCreate
      - name: lib-modules
        hostPath:
          path: /lib/modules
      - name: dbus
        hostPath:
          path: /var/run/dbus/system_bus_socket
      - name: etc-kubernetes
        hostPath:
          path: /etc/kubernetes
      - name: var-lib-kubelet-pki
        hostPath:
          path: /var/lib/kubelet/pki
          type: DirectoryOrCreate
