# Copyright 2022 The Kubermatic Kubernetes Platform contributors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Simplified Consul configuration for Kubermatic MLA stack
# This file only contains overrides to the default Consul Helm chart values.
# For complete default values, see: https://github.com/hashicorp/consul-k8s/blob/v1.9.2/charts/consul/values.yaml

consul:
  global:
    # Use Consul 1.22.2 (latest stable as of chart v1.9.2)
    image: "docker.io/hashicorp/consul:1.22.2"
    
    # Add consul-dataplane image (required for v1.9.2)
    imageConsulDataplane: "docker.io/hashicorp/consul-dataplane:1.9.0"
    
    # Explicitly disable metrics (matches our use case: KV storage only)
    metrics:
      enabled: false

  server:
    # Run 3 servers for HA (default is 1)
    replicas: 3
    
    storageClass: kubermatic-fast
    
    # Conservative resource limits for KV-only usage
    resources:
      requests:
        memory: "100Mi"
        cpu: "100m"
      limits:
        memory: "100Mi"
        cpu: "100m"
    
    # Relaxed anti-affinity to support e2e clusters with fewer nodes
    # Uses preferred (not required) scheduling to avoid blocking deployments
    affinity: |
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: {{ template "consul.name" . }}
                  release: "{{ .Release.Name }}"
                  component: server
              topologyKey: kubernetes.io/hostname
    
    # Allow cluster autoscaler to evict pods when needed
    annotations: |
      "cluster-autoscaler.kubernetes.io/safe-to-evict-local-volumes": "extra-config"

  # Disable all unused Consul features (we only need KV storage)
  client:
    enabled: false
  
  connectInject:
    enabled: false
  
  syncCatalog:
    enabled: false
  
  meshGateway:
    enabled: false
  
  ingressGateways:
    enabled: false
  
  terminatingGateways:
    enabled: false
