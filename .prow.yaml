# Copyright 2020 The Kubermatic Kubernetes Platform contributors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

presubmits:

  #########################################################
  # unit tests
  #########################################################

  - name: pre-kubermatic-test
    run_if_changed: "^(cmd|codegen|hack|pkg)/"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-6
        command:
        - make
        args:
        - test
        resources:
          requests:
            memory: 7Gi
            cpu: 2
        env:
        - name: KUBERMATIC_EDITION
          value: ee

  - name: pre-kubermatic-test-integration
    run_if_changed: "^(cmd|codegen|hack|pkg)/"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-vsphere: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/integration-tests:5-0
        command:
        - make
        args:
        - test-integration
        # docker-in-docker (for localstack) needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 2
          limits:
            memory: 6Gi
            cpu: 2
        env:
        - name: KUBERMATIC_EDITION
          value: ee

  - name: pre-kubermatic-verify
    always_run: true
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    path_alias: k8c.io/kubermatic
    labels:
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-6
        command:
        - ./hack/ci/verify.sh
        resources:
          requests:
            memory: 2Gi
            cpu: 2
        env:
        - name: KUBERMATIC_EDITION
          value: ee

  - name: pre-kubermatic-lint
    run_if_changed: "^(cmd|codegen|hack|pkg)/"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-goproxy: "true"
    spec:
      containers:
      - image: golangci/golangci-lint:v1.43.0
        command:
        - make
        args:
        - lint
        resources:
          requests:
            memory: 10Gi
            cpu: 3
        env:
        - name: KUBERMATIC_EDITION
          value: ee

  - name: pre-kubermatic-shellcheck
    optional: true
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-goproxy: "true"
    spec:
      containers:
      - image: koalaman/shellcheck-alpine:v0.7.0
        command:
        - sh
        args:
        - -c
        - shellcheck --shell=bash $(find . -name '*.sh')
        resources:
          requests:
            memory: 1Gi
            cpu: 0.5
        env:
        - name: KUBERMATIC_EDITION
          value: ee

  - name: pre-kubermatic-verify-boilerplate
    always_run: true
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic-labs/boilerplate:v0.2.0
        command:
        - ./hack/verify-boilerplate.sh
        resources:
          requests:
            memory: 256Mi
            cpu: 100m

  - name: pre-kubermatic-simulate-github-release
    run_if_changed: "hack/ci/github-release.sh"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-6
        command:
        - ./hack/ci/test-github-release.sh
        resources:
          requests:
            memory: 3Gi
            cpu: 2

  - name: pre-kubermatic-test-helm-charts
    run_if_changed: "charts/"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-docker-pull: "true"
      preset-kind-volume-mounts: "true"
      preset-vault: "true"
      preset-goproxy: "true"
    spec:
      containers:
        - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
          command:
            - "./hack/ci/test-helm-charts.sh"
          env:
            - name: KUBERMATIC_EDITION
              value: ee
          securityContext:
            privileged: true
          resources:
            requests:
              memory: 4Gi
              cpu: 2
            limits:
              memory: 6Gi

  - name: pre-kubermatic-test-user-ssh-key-agent-multiarch
    decorate: true
    always_run: false
    run_if_changed: "cmd/user-ssh-keys-agent/"
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        command:
        - "./hack/ci/run-user-ssh-key-agent-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3
          limits:
            memory: 4Gi
            cpu: 3

  #########################################################
  # Base Kubernetes Tests (AWS, Flatcar)
  #########################################################

  - name: pre-kubermatic-e2e-aws-ubuntu-1.20
    decorate: true
    run_if_changed: "(cmd/|codegen/|hack/|pkg/|charts/kubermatic|addons/|.prow.yaml)"
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-aws: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-vault: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.20.14"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-aws-ubuntu-1.21
    decorate: true
    run_if_changed: "(cmd/|codegen/|hack/|pkg/|charts/kubermatic|addons/|.prow.yaml)"
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-aws: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-vault: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.21.12"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-aws-ubuntu-1.22
    decorate: true
    run_if_changed: "(cmd/|codegen/|hack/|pkg/|charts/kubermatic|addons/|.prow.yaml)"
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-aws: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-vault: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.22.9"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-aws-ubuntu-1.23
    decorate: true
    run_if_changed: "(cmd/|codegen/|hack/|pkg/|charts/kubermatic|addons/|.prow.yaml)"
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-aws: "true"
      preset-docker-mirror: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-vault: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-aws-ubuntu-1.23-ce
    decorate: true
    run_if_changed: "(cmd/|codegen/|hack/|pkg/|charts/kubermatic|addons/|.prow.yaml)"
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-aws: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-vault: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: "ce"
        - name: ONLY_TEST_CREATION
          value: "true"
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  #########################################################
  # Extended Kubernetes Tests (various cloud providers, OS)
  #########################################################

  - name: pre-kubermatic-e2e-azure-ubuntu-1.23
    decorate: true
    optional: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-azure: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: PROVIDER
          value: "azure"
        - name: DEFAULT_TIMEOUT_MINUTES
          value: "20"
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-gcp-ubuntu-1.23
    decorate: true
    always_run: false
    optional: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-gce: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "gcp"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-gcp-ubuntu-1.23-psp
    decorate: true
    optional: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-gce: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "gcp"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: KUBERMATIC_PSP_ENABLED
          value: "true"
        - name: ONLY_TEST_CREATION
          value: "true"
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-do-centos-1.23
    decorate: true
    always_run: false
    optional: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-digitalocean: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: DISTRIBUTIONS
          value: centos
        - name: PROVIDER
          value: "digitalocean"
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-packet-ubuntu-1.23
    decorate: true
    optional: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-packet: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "packet"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-kubevirt-centos-1.23
    decorate: true
    optional: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-kubevirt: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "kubevirt"
        - name: DISTRIBUTIONS
          value: centos
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-hetzner-ubuntu-1.23
    decorate: true
    optional: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-hetzner: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "hetzner"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: DEFAULT_TIMEOUT_MINUTES
          value: "20"
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-openstack-ubuntu-1.23
    decorate: true
    optional: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-openstack: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "openstack"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: DEFAULT_TIMEOUT_MINUTES
          value: "20"
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-openstack-centos-1.23
    decorate: true
    optional: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-openstack: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "openstack"
        - name: DEFAULT_TIMEOUT_MINUTES
          value: "20"
        - name: DISTRIBUTIONS
          value: centos
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-vsphere-ubuntu-1.23
    decorate: true
    run_if_changed: "(addons/csi/vsphere|pkg/provider/cloud/vsphere)"
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-vsphere: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "vsphere"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-vsphere-ubuntu-1.23-customfolder
    decorate: true
    optional: true
    run_if_changed: "(addons/csi/vsphere|pkg/provider/cloud/vsphere)"
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-vsphere: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "vsphere"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: SCENARIO_OPTIONS
          value: "custom-folder"
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-vsphere-ubuntu-1.23-datastore-cluster
    decorate: true
    optional: true
    run_if_changed: "(addons/csi/vsphere|pkg/provider/cloud/vsphere)"
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-vsphere: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "vsphere"
        - name: DISTRIBUTIONS
          value: ubuntu
        - name: SCENARIO_OPTIONS
          value: "datastore-cluster"
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-nutanix-ubuntu-1.23
    decorate: true
    optional: true
    run_if_changed: "(addons/csi/nutanix|pkg/provider/cloud/nutanix)"
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-nutanix: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "nutanix"
        - name: DISTRIBUTIONS
          value: "ubuntu"
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  - name: pre-kubermatic-e2e-nutanix-centos-1.23
    decorate: true
    optional: true
    run_if_changed: "(addons/csi/nutanix|pkg/provider/cloud/nutanix)"
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-nutanix: "true"
      preset-vault: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-e2e-ssh: "true"
      preset-kubeconfig-ci: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        env:
        - name: KUBERMATIC_EDITION
          value: ee
        - name: VERSIONS_TO_TEST
          value: "v1.23.6"
        - name: PROVIDER
          value: "nutanix"
        - name: DISTRIBUTIONS
          value: "centos"
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        command:
        - "./hack/ci/run-e2e-tests.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 3.5
          limits:
            memory: 4Gi

  #########################################################
  # REST API e2e tests
  #########################################################

  - name: pre-kubermatic-api-e2e
    run_if_changed: "(cmd/|codegen/|hack/|pkg/|charts/kubermatic|.prow.yaml)"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-digitalocean: "true"
      preset-openstack: "true"
      preset-azure: "true"
      preset-kubeconfig-ci: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-gce: "true"
      preset-kind-volume-mounts: "true"
      preset-vault: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        imagePullPolicy: Always
        command:
        - "./hack/ci/run-api-e2e.sh"
        env:
        - name: VERSION_TO_TEST
          value: v1.23.6
        - name: KUBERMATIC_EDITION
          value: ee
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 2
          limits:
            memory: 6Gi

  #########################################################
  # etcd-launcher e2e tests
  #########################################################

  - name: pre-kubermatic-etcd-launcher-e2e
    run_if_changed: "(cmd/etcd-launcher/|pkg/|.prow.yaml)"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-digitalocean: "true"
      preset-kubeconfig-ci: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-kind-volume-mounts: "true"
      preset-vault: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        command:
        - "./hack/ci/run-etcd-launcher-tests.sh"
        env:
        - name: VERSION_TO_TEST
          value: v1.23.6
        - name: KUBERMATIC_EDITION
          value: ee
        - name: SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: e2e-ci
              key: serviceAccountSigningKey
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 2
          limits:
            memory: 6Gi

  #########################################################
  # NodePort Proxy e2e tests
  #########################################################

  - name: pre-kubermatic-nodeport-proxy-e2e
    run_if_changed: "(cmd/nodeport-proxy/|pkg/|.prow.yaml)"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        imagePullPolicy: Always
        command:
        - ./hack/run-nodeport-proxy-e2e-test-in-kind.sh
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 2
          limits:
            memory: 6Gi

  #########################################################
  # opa e2e tests
  #########################################################

  - name: pre-kubermatic-opa-e2e
    run_if_changed: "(go.mod|go.sum|pkg/|.prow.yaml)"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-digitalocean: "true"
      preset-kubeconfig-ci: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-kind-volume-mounts: "true"
      preset-vault: "true"
      preset-goproxy: "true"
    spec:
      containers:
        - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
          command:
            - "./hack/ci/run-opa-e2e-tests.sh"
          env:
            - name: VERSION_TO_TEST
              value: v1.23.6
            - name: KUBERMATIC_EDITION
              value: ee
            - name: SERVICE_ACCOUNT_KEY
              valueFrom:
                secretKeyRef:
                  name: e2e-ci
                  key: serviceAccountSigningKey
          securityContext:
            privileged: true
          resources:
            requests:
              memory: 4Gi
              cpu: 2
            limits:
              memory: 6Gi

  #########################################################
  # Expose Strategy e2e tests
  #########################################################

  - name: pre-kubermatic-expose-strategy-e2e
    run_if_changed: "(cmd/nodeport-proxy/|pkg/|.prow.yaml)"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        imagePullPolicy: Always
        command:
        - ./hack/run-expose-strategy-e2e-test-in-kind.sh
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 4Gi
            cpu: 2
          limits:
            memory: 6Gi

  #########################################################
  # external ccm migration e2e tests
  #########################################################

  - name: pre-kubermatic-ccm-migration-e2e
    run_if_changed: "(pkg/|.prow.yaml)"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-openstack: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-kind-volume-mounts: "true"
      preset-goproxy: "true"
    spec:
      containers:
        - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
          env:
            - name: KUBERMATIC_EDITION
              value: ce
          command:
            - ./hack/run-ccm-migration-e2e-test-in-kind.sh
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: 4Gi
              cpu: 3.5
            limits:
              memory: 4Gi

  #########################################################
  # misc
  #########################################################

  - name: pre-kubermatic-e2e-gcp-offline
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-gce: "true"
      preset-vault: "true"
      preset-docker-push: "true"
      preset-repo-ssh: "true"
      preset-goproxy: "true"
    spec:
      containers:
      - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
        command:
        - "./hack/ci/run-offline-test.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: 2.5Gi
            cpu: 500m
          limits:
            memory: 4Gi
            cpu: 2

  #########################################################
  # User cluster MLA e2e tests
  #########################################################

  - name: pre-kubermatic-mla-e2e
    run_if_changed: "(go.mod|go.sum|pkg/|.prow.yaml)"
    decorate: true
    clone_uri: "ssh://git@github.com/kubermatic/kubermatic.git"
    labels:
      preset-digitalocean: "true"
      preset-kubeconfig-ci: "true"
      preset-docker-pull: "true"
      preset-docker-push: "true"
      preset-kind-volume-mounts: "true"
      preset-vault: "true"
      preset-goproxy: "true"
    spec:
      containers:
        - image: quay.io/kubermatic/build:go-1.17-node-16-kind-0.12-8
          command:
            - "./hack/ci/run-mla-e2e-tests.sh"
          env:
            - name: VERSION_TO_TEST
              value: v1.23.6
            - name: KUBERMATIC_EDITION
              value: ee
            - name: SERVICE_ACCOUNT_KEY
              valueFrom:
                secretKeyRef:
                  name: e2e-ci
                  key: serviceAccountSigningKey
          securityContext:
            privileged: true
          resources:
            requests:
              memory: 14Gi
              cpu: 4
            limits:
              memory: 18Gi
